<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Live Stream — Stable</title>

  <!-- Shaka core (unchanged) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

  <style>
    :root{
      --sky-1:#e6f7ff; --sky-2:#f8fbff;
      --dark-pink:#d81b60; --promo-red:#ff1f1f;
      /* dynamic viewport fallback for mobile address bar */
      --vh: 100dvh; /* modern */ /* falls back below via JS for older */ 
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:#071427;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.10) 0.4px, transparent 0.6px),
        radial-gradient(circle at 30% 60%, rgba(255,255,255,0.06) 0.4px, transparent 0.6px),
        linear-gradient(180deg,var(--sky-1) 0%, var(--sky-2) 100%);
      background-size:40px 40px,40px 40px,auto;min-height:var(--vh);
    }

    .page{max-width:1100px;margin:18px auto;padding:12px}
    h1.title{font-size:20px;margin-bottom:10px;color:#071427}

    .controls-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .controls-row label{font-weight:700}
    .controls-row select,.controls-row button{
      padding:8px 12px;border-radius:8px;border:0;background:#0b1220;color:#fff;cursor:pointer;font-weight:600;
      box-shadow:0 6px 18px rgba(11,18,32,0.12);
    }

    /* Base player wrapper */
    .player-wrapper{
      width:100%;max-width:1000px;margin:0 auto;position:relative;border-radius:12px;overflow:hidden;
      box-shadow:0 12px 40px rgba(7,20,40,0.12);background:#000
    }
    .player-wrapper.aspect-16-9{padding-top:56.25%}
    .player-wrapper.aspect-4-3{padding-top:75%}
    .player-wrapper.aspect-1-1{padding-top:100%}
    .player-wrapper.aspect-fit{padding-top:56.25%}
    .player-wrapper.aspect-fill{padding-top:0;height:calc(var(--vh) * 0.6)}

    .shaka-video-container{position:absolute;inset:0;width:100%;height:100%}
    .shaka-video-container video{width:100%;height:100%;object-fit:contain;background:#000}

    /* Server 2: 16:9 frame with pinch target */
    .iframe-wrapper{position:absolute;inset:0;display:none;background:#000;align-items:center;justify-content:center}
    .server2-frame{
      position:relative;width:100%;max-height:100%;aspect-ratio:16/9;overflow:hidden;background:#000;
      touch-action:none; /* enable custom pinch-zoom */  /* MDN */
      will-change:transform;
    }
    .server2-frame iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:#000}

    /* Overlay (landscape toggle) */
    .overlay-btn{
      position:absolute;top:12px;right:12px;z-index:10000;width:44px;height:44px;border-radius:22px;
      display:flex;align-items:center;justify-content:center;background:rgba(11,18,32,0.75);color:#fff;font-weight:800;
      border:1px solid rgba(255,255,255,0.08);cursor:pointer;font-size:16px;box-shadow:0 8px 22px rgba(11,18,32,0.28);
    }

    .zoom-hud{position:absolute;left:12px;top:12px;background:rgba(11,18,32,0.7);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;z-index:10000;display:none}

    .server2-area{max-width:1000px;margin:12px auto;display:flex;justify-content:center}
    .server2-btn{padding:12px 18px;border-radius:10px;background:var(--dark-pink);color:#fff;font-weight:800;border:0;cursor:pointer;box-shadow:0 8px 22px rgba(216,27,96,0.18)}

    .promo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:760px;margin:16px auto}
    .promo-grid a{display:flex;align-items:center;justify-content:center;padding:10px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.06);text-decoration:none;font-weight:700;color:var(--promo-red);font-size:12px}
    .promo-cta{display:block;text-align:center;margin:12px auto;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,#ff4d4d,#ff7a6a);color:#fff;font-weight:900;text-decoration:none;max-width:760px}
    footer{margin-top:14px;text-align:center;color:#071427;font-weight:700}

    /* Landscape viewport-fill for any player */
    .landscape-full{
      position:fixed !important;inset:0 !important;width:100vw !important;height:100dvh !important;background:#000 !important; /* dvh avoids address bar jumps */
      z-index:9999 !important;border-radius:0 !important;max-width:none !important;padding-top:0 !important;margin:0 !important;
      display:flex;align-items:center;justify-content:center;
    }
    .landscape-full .shaka-video-container,
    .landscape-full .server2-frame{width:100vw !important;height:100dvh !important;aspect-ratio:auto !important}
    .landscape-full video,
    .landscape-full iframe{width:100% !important;height:100% !important;object-fit:cover !important}

    @media (max-width:720px){
      .controls-row{justify-content:center}
    }
  </style>
</head>
<body>
  <div class="page">
    <h1 class="title">Live Stream</h1>

    <div class="controls-row" aria-label="Player controls">
      <label for="aspectSelect">Aspect:</label>
      <select id="aspectSelect" aria-label="Aspect ratio selector">
        <option value="aspect-16-9" selected>16:9</option>
        <option value="aspect-4-3">4:3</option>
        <option value="aspect-1-1">1:1</option>
        <option value="aspect-fit">Fit to Width</option>
        <option value="aspect-fill">Fill to Screen</option>
      </select>
      <button id="cinemaBtn">Cinema</button>
      <button id="fsBtn">Fullscreen</button>
      <button id="vrBtn">VR</button>
    </div>

    <div id="playerWrapper" class="player-wrapper aspect-16-9">
      <!-- Shaka -->
      <div class="shaka-video-container" data-shaka-player>
        <video id="mainVideo" autoplay playsinline preload="metadata" poster="https://i.ibb.co/PGkCs5vz/ab188872-6178-43c2-a831-22a3de37390b.png"></video>
      </div>

      <!-- Server 2 (16:9 frame) -->
      <div id="iframeWrapper" class="iframe-wrapper" aria-hidden="true">
        <div id="server2Frame" class="server2-frame">
          <iframe id="server2Iframe" src="" allow="autoplay; fullscreen" allowfullscreen referrerpolicy="no-referrer"></iframe>
        </div>
      </div>

      <div id="zoomHud" class="zoom-hud">Zoom 100%</div>
    </div>

    <div class="server2-area">
      <button id="server2Btn" class="server2-btn">Server 2</button>
    </div>

    <div class="promo-grid" aria-hidden="false">
      <a href="https://t.me/+-c580a3MZ05mNGFl" target="_blank" rel="noopener">JOIN CHANNEL 1</a>
      <a href="https://t.me/+-c580a3MZ05mNGFl" target="_blank" rel="noopener">JOIN CHANNEL 2</a>
      <a href="https://t.me/+-c580a3MZ05mNGFl" target="_blank" rel="noopener">JOIN CHANNEL 3</a>
      <a href="https://t.me/+-c580a3MZ05mNGFl" target="_blank" rel="noopener">JOIN CHANNEL 4</a>
    </div>

    <a class="promo-cta" href="https://t.me/+-c580a3MZ05mNGFl" target="_blank" rel="noopener">सभी लोग हमारे प्रीमियम सदस्य बनने के लिए JOIN करें</a>

    <footer>©</footer>
  </div>

  <!-- Shaka Player (original logic unchanged) -->
  <script>
    // Fix 100vh on mobile: compute --vh for older browsers that lack dvh
    (function fixVH(){
      const set = ()=>document.documentElement.style.setProperty('--vh', (window.innerHeight)+'px');
      set(); addEventListener('resize', set); addEventListener('orientationchange', set);
    })(); /* 100vh mobile fix */ /* based on dynamic viewport guidance */

    document.addEventListener('DOMContentLoaded', async () => {
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) { console.error('Browser not supported'); return; }

      const video = document.getElementById('mainVideo');
      const player = new shaka.Player();
      await player.attach(video);

      const container = document.querySelector('.shaka-video-container');
      const ui = new shaka.ui.Overlay(player, container, video);

      ui.configure({
        controlPanelElements: [
          'play_pause','time_and_duration','mute','volume','spacer','language','captions',
          'picture_in_picture','quality','fullscreen'
        ],
        volumeBarColors:{ base:'rgba(255,192,203,0.3)', level:'rgb(255,105,180)' },
        seekBarColors:{ base:'rgba(255,255,0,0.3)', buffered:'rgba(255,255,0,0.6)', played:'rgb(255,255,0)' }
      });

      // DRM/stream (unchanged sample)
      let drmConfig = { clearKeys: { "31b13c6f241055aaa965263f3115e684": "61f0cbc9599925a7be93d45e30b8ebe9" } };
      let cookieHeader = "__hdnea__=st=1758392406~exp=1758478806~acl=/*~hmac=48d94f13ec574d6d9798365f006cd430ccd5ca3d776bde0a3335f979bf794bc5";
      let streamUrl = "https://jiotvbpkmob.cdn.jio.com/bpk-tv/Asia_Cup_Hindi_MOB/WDVLive/index.mpd?__hdnea__=st=1758392406~exp=1758478806~acl=/*~hmac=48d94f13ec574d6d9798365f006cd430ccd5ca3d776bde0a3335f979bf794bc5";

      player.configure({
        drm: drmConfig,
        streaming: {
          lowLatencyMode: true, bufferingGoal: 15, rebufferingGoal: 2, bufferBehind: 15,
          retryParameters: { timeout:10000, maxAttempts:5, baseDelay:300, backoffFactor:1.2 },
          segmentRequestTimeout:8000, segmentPrefetchLimit:2, useNativeHlsOnSafari:true
        },
        manifest: { retryParameters:{ timeout:8000, maxAttempts:3 } }
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers['Referer'] = 'https://www.jiotv.com/';
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        request.headers['Cookie'] = cookieHeader;
        if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
             type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
            request.uris[0] && !request.uris[0].includes('__hdnea=')) {
          const s = request.uris[0].includes('?') ? '&' : '?';
          request.uris[0] += s + cookieHeader;
        }
      });

      const attemptAutoplay = async () => {
        try { video.muted = false; await video.play(); return true; }
        catch(e){ try{ video.muted = true; await video.play(); return true; } catch(e2){ return false; } }
      };

      try { await player.load(streamUrl); await attemptAutoplay(); } catch(e){ console.error(e); }
    });
  </script>

  <!-- Server 2 + Landscape + Pinch Zoom -->
  <script>
    const SERVICE2_URL = "https://lins.onrender.com/"; // set stream page

    (function(){
      const server2Btn = document.getElementById('server2Btn');
      const playerWrapper = document.getElementById('playerWrapper');
      const iframeWrapper = document.getElementById('iframeWrapper');
      const server2Frame = document.getElementById('server2Frame');
      const iframe = document.getElementById('server2Iframe');
      const shakaContainer = document.querySelector('.shaka-video-container');
      const zoomHud = document.getElementById('zoomHud');

      const overlayBtn = document.createElement('button');
      overlayBtn.className = 'overlay-btn';
      overlayBtn.title = 'Landscape';
      overlayBtn.textContent = '⟲';
      overlayBtn.style.display = 'none';
      playerWrapper.appendChild(overlayBtn);

      let open = false, land = false;

      async function lockLandscape(){
        try{ if(screen.orientation && screen.orientation.lock){ await screen.orientation.lock('landscape-primary'); } }
        catch(e){ /* must be user gesture; ignore if fails */ }
      }
      function unlockOrientation(){ try{ screen.orientation && screen.orientation.unlock && screen.orientation.unlock(); }catch(e){} }

      function enterLandscape(){
        playerWrapper.classList.add('landscape-full');
        overlayBtn.textContent = '×'; land = true; zoomHud.style.display = open ? 'block' : 'none';
      }
      function exitLandscape(){
        playerWrapper.classList.remove('landscape-full');
        overlayBtn.textContent = '⟲'; land = false; zoomHud.style.display = 'none'; unlockOrientation();
      }

      overlayBtn.addEventListener('click', async ()=>{
        if(!land){ enterLandscape(); await lockLandscape(); } else { exitLandscape(); }
      });

      server2Btn.addEventListener('click', async ()=>{
        open = !open;
        if(open){
          shakaContainer.style.display = 'none';
          iframeWrapper.style.display = 'flex';
          iframeWrapper.setAttribute('aria-hidden','false');
          iframe.src = SERVICE2_URL + (SERVICE2_URL.includes('?') ? '&' : '?') + 'autoplay=1';
          overlayBtn.style.display = 'flex';
          server2Btn.textContent = 'Close Server 2';
          // Force landscape right now (user gesture)
          enterLandscape(); await lockLandscape();
          // reset zoom
          scale=1; panX=0; panY=0; apply();
        }else{
          iframe.src = '';
          iframeWrapper.style.display = 'none';
          iframeWrapper.setAttribute('aria-hidden','true');
          overlayBtn.style.display = 'none';
          server2Btn.textContent = 'Server 2';
          shakaContainer.style.display = '';
          if(land) exitLandscape();
        }
      });

      // Aspect selector
      const aspectSelect = document.getElementById('aspectSelect');
      aspectSelect.addEventListener('change', ()=>{
        const cls = aspectSelect.value;
        playerWrapper.classList.remove('aspect-16-9','aspect-4-3','aspect-1-1','aspect-fit','aspect-fill');
        playerWrapper.classList.add(cls);
      });

      // Pinch zoom + pan (Pointer Events)
      let scale=1, minS=1, maxS=3, panX=0, panY=0;
      let evCache=[], prevDiff=-1;

      function apply(){
        server2Frame.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        zoomHud.textContent = `Zoom ${Math.round(scale*100)}%`;
      }

      function cacheUpdate(ev){
        const i = evCache.findIndex(e => e.pointerId === ev.pointerId);
        if(i > -1) evCache[i] = ev; else evCache.push(ev);
      }
      function cacheRemove(ev){
        const i = evCache.findIndex(e => e.pointerId === ev.pointerId);
        if(i > -1) evCache.splice(i,1);
        if(evCache.length < 2) prevDiff = -1;
      }

      server2Frame.addEventListener('pointerdown', (ev)=>{ server2Frame.setPointerCapture(ev.pointerId); cacheUpdate(ev); });
      server2Frame.addEventListener('pointermove', (ev)=>{
        cacheUpdate(ev);
        if(evCache.length === 2){
          ev.preventDefault();
          const curDiff = Math.hypot(evCache[0].clientX-evCache[1].clientX, evCache[0].clientY-evCache[1].clientY);
          if(prevDiff > 0){
            const ratio = curDiff/prevDiff;
            const ns = Math.min(maxS, Math.max(minS, scale * ratio));
            // focal center keep
            const midX=(evCache[0].clientX+evCache[1].clientX)/2 - innerWidth/2;
            const midY=(evCache[0].clientY+evCache[1].clientY)/2 - innerHeight/2;
            panX += (panX - midX) * (ns/scale - 1);
            panY += (panY - midY) * (ns/scale - 1);
            scale = ns; apply();
          }
          prevDiff = curDiff;
        }else if(evCache.length === 1){
          panX += ev.movementX; panY += ev.movementY; apply();
        }
      }, { passive:false });
      ['pointerup','pointercancel','pointerout','pointerleave'].forEach(type=>{
        server2Frame.addEventListener(type, cacheRemove);
      });

      // Optional: ESC to exit
      addEventListener('keydown', (e)=>{ if(e.key==='Escape' && land) exitLandscape(); });
    })();
  </script>
</body>
</html>
